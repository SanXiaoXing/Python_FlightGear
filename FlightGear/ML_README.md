# FlightGear机器学习自动驾驶系统

## 概述

这是一个基于机器学习的FlightGear自动驾驶系统，使用强化学习和神经网络来智能控制飞机的起飞、飞行和着陆操作。系统能够通过学习和适应来处理各种复杂的飞行情况。

## 主要特性

### 🧠 智能学习能力
- **强化学习代理**：使用深度Q网络(DQN)进行决策
- **专家知识融合**：结合飞行专家经验指导学习
- **自适应控制**：根据不同飞行阶段动态调整策略

### 🛫 智能起飞系统
- **多阶段起飞**：地面滑行 → 加速 → 拉升 → 爬升
- **实时状态监控**：速度、高度、油门、起落架等
- **安全保护机制**：防止失速、超速等危险情况

### 📊 训练与推理
- **训练模式**：通过多轮飞行训练提升性能
- **推理模式**：使用训练好的模型执行任务
- **测试模式**：使用专家知识验证系统

## 系统要求

### 必需软件
- **FlightGear** (最新版本)
- **Python 3.7+**
- **flightgear-python** 库

### 可选依赖
- **TensorFlow 2.x** (推荐，用于深度学习)
- **NumPy** (数值计算)
- **tqdm** (进度显示)

### 安装依赖
```bash
pip install flightgear-python tensorflow numpy tqdm
```

## 使用方法

### 1. 启动FlightGear

启动FlightGear时需要启用Telnet服务器：

```bash
fgfs --telnet=socket,bi,60,localhost,5500,tcp
```

或在FlightGear启动器中添加额外参数：
```
--telnet=socket,bi,60,localhost,5500,tcp
```

### 2. 运行机器学习自动驾驶

```bash
python ml_autopilot.py
```

### 3. 选择运行模式

#### 训练模式
- 用于训练起飞代理
- 通过多轮飞行学习最优策略
- 自动保存训练模型

#### 推理模式
- 使用训练好的模型执行起飞
- 需要先有训练好的模型文件
- 性能最优，适合实际使用

#### 测试模式
- 使用专家知识执行起飞
- 无需训练，立即可用
- 适合验证系统功能

### 4. 选择飞行路线

系统预设了多条飞行路线：
- **BIKF到BGBW**：冰岛到格陵兰
- **PANC到PAFA**：阿拉斯加安克雷奇到费尔班克斯
- **PHNL到PHOG**：夏威夷檀香山到卡胡卢伊

## 技术架构

### 核心组件

#### 1. FlightState (飞行状态)
```python
- 高度 (altitude)
- 空速 (airspeed) 
- 航向 (heading)
- 油门 (throttle)
- 起落架状态 (gear_down)
- 襟翼位置 (flaps)
- 俯仰角 (pitch)
- 滚转角 (roll)
- 垂直速度 (vertical_speed)
- 地速 (ground_speed)
```

#### 2. FlightAction (飞行动作)
```python
- 油门变化量 (throttle_delta)
- 起落架动作 (gear_action)
- 襟翼变化量 (flaps_delta)
```

#### 3. TakeoffAgent (起飞代理)
- **神经网络模型**：输入状态，输出动作
- **奖励函数**：评估动作质量
- **经验回放**：存储和学习历史经验
- **探索策略**：平衡探索和利用

### 起飞阶段定义

| 阶段 | 速度范围(节) | 目标油门 | 主要动作 |
|------|-------------|----------|----------|
| 地面 | 0-30 | 0.3 | 增加油门，放下起落架 |
| 加速 | 30-60 | 0.8 | 继续加速 |
| 拉升 | 60-80 | 0.9 | 准备收起落架 |
| 爬升 | 80+ | 0.8 | 收起起落架和襟翼 |

### 奖励函数设计

```python
基础奖励: +1.0 (保持飞行)
速度奖励: +5.0 (在目标速度范围内)
高度奖励: +10.0 (成功爬升)
油门控制: +2.0 (接近目标油门)
起落架控制: +2.0 (正确的起落架状态)

惩罚项:
- 速度过快: -10.0
- 坠毁: -100.0
```

## 模型文件

### 保存格式
- **TensorFlow模型**: `.h5` 或 SavedModel 格式
- **简化模型**: `.json` 格式 (权重和偏置)

### 自动保存
- 训练过程中每10轮自动保存
- 训练结束保存最终模型
- 文件命名: `takeoff_model_episode_X` 或 `takeoff_model_final`

## 性能监控

### 实时显示
- 当前飞行阶段
- 高度和速度
- 起飞进度百分比
- 训练轮次和成功率

### 训练指标
- 成功起飞率
- 平均完成步数
- 奖励值变化
- 探索率衰减

## 故障排除

### 常见问题

#### 1. 连接失败
```
错误: 无法连接到FlightGear
解决: 确保FlightGear启用了Telnet服务器
参数: --telnet=socket,bi,60,localhost,5500,tcp
```

#### 2. 起飞失败
```
问题: 飞机无法起飞或坠毁
解决: 
- 检查初始位置是否在跑道上
- 确保飞机型号支持起飞
- 尝试使用测试模式验证
```

#### 3. 训练效果差
```
问题: 训练后成功率低
解决:
- 增加训练轮数
- 调整奖励函数参数
- 检查专家知识是否正确
```

#### 4. 模型加载失败
```
问题: 无法加载训练好的模型
解决:
- 检查模型文件路径
- 确保模型文件完整
- 尝试重新训练
```

## 扩展开发

### 添加新的飞行阶段
1. 在 `takeoff_phases` 中定义新阶段
2. 更新 `get_takeoff_phase` 方法
3. 在 `get_expert_action` 中添加对应逻辑

### 自定义奖励函数
1. 修改 `calculate_reward` 方法
2. 根据具体需求调整奖励权重
3. 添加新的评估指标

### 支持新飞机型号
1. 调整控制参数范围
2. 修改起飞速度阈值
3. 适配特定的控制接口

## 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 贡献

欢迎提交Issue和Pull Request来改进这个项目！

---

**注意**: 这是一个实验性项目，请在安全的模拟环境中使用。实际飞行请遵循相关法规和安全规程。